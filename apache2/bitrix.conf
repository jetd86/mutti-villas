<VirtualHost *:80>
    DocumentRoot /var/www/html
    ServerName localhost

    <Directory /var/www/html>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # Настройка PHP-FPM с правильными заголовками
    <FilesMatch \.php$>
        SetHandler "proxy:fcgi://bitrix_php8.4.8-fpm:9000"
        # Передаем правильные заголовки для AJAX
        SetEnvIf Request_URI "\.php$" SCRIPT_FILENAME=$document_root$request_uri
    </FilesMatch>

    # Включаем mod_rewrite для ЧПУ
    RewriteEngine On

    # Правила для корректной обработки AJAX запросов
    RewriteCond %{HTTP:X-Requested-With} ^XMLHttpRequest$ [NC]
    RewriteRule ^(.*)$ - [E=AJAX:1]

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    # Безопасность
    <Files ".ht*">
        Require all denied
    </Files>

    # Настройки для Битрикс
    <Directory /var/www/html/bitrix>
        <Files "*.php">
            Require all granted
        </Files>
    </Directory>

    # Заголовки для AJAX запросов
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header always set Access-Control-Allow-Headers "X-Requested-With, Content-Type"
</VirtualHost>
