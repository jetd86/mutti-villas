<? namespace Bitrix\Main\Security\W;$GLOBALS['____1606185122']= array(base64_decode(''.'dGl'.'tZQ='.'='),base64_decode(''.'dG'.'l'.'t'.'ZQ=='),base64_decode('anN'.'vbl9kZWN'.'vZGU'.'='),base64_decode('YX'.'J'.'yY'.'Xlf'.'bWVyZ2U'.'='),base64_decode('am9pbg=='),base64_decode('a'.'m9p'.'b'.'g='.'='),base64_decode('am9'.'pbg=='),base64_decode('YXJ'.'yYX'.'lfc'.'G9w'),base64_decode('YXJyY'.'Xlfc'.'2hpZnQ'.'='),base64_decode('YXJyYXlfc2hpZnQ'.'='),base64_decode('YXJyYXlfc2hpZnQ='),base64_decode('Y'.'XJy'.'Y'.'Xlfc2'.'h'.'pZnQ='),base64_decode('YXJy'.'Y'.'X'.'lfb'.'W'.'VyZ2'.'U'.'='),base64_decode('a'.'XNfYXJyYXk='),base64_decode('YXJyYXl'.'fb'.'W'.'VyZ2U='),base64_decode(''.'aW5fYXJyYXk'.'='),base64_decode('aW5fYX'.'J'.'yYXk='),base64_decode(''.'aW5'.'fYX'.'J'.'y'.'YX'.'k='),base64_decode('aW5fYXJyYXk='),base64_decode('aW5fYXJyY'.'Xk'.'='),base64_decode(''.'dGltZQ='.'='),base64_decode('dGlt'.'ZQ=='),base64_decode('YXJ'.'yYXlfbWFw'),base64_decode('Z2V0'.'X2'.'xv'.'YWRlZF'.'9leHR'.'lbnNpb'.'25z'),base64_decode('anNvbl9'.'lbm'.'NvZG'.'U='),base64_decode('anN'.'vbl9lbmNvZGU='),base64_decode('cG'.'hwd'.'mVy'.'c2lvbg=='),base64_decode('a'.'nNvbl9l'.'bmNvZGU='),base64_decode('a'.'m'.'9pbg=='));if(!function_exists(__NAMESPACE__.'\\___1059425104')){function ___1059425104($_445749331){static $_1877197783= false; if($_1877197783 == false) $_1877197783=array(''.'V1dBTExf'.'T'.'E9DSw='.'=',''.'c2'.'VjdXJpdHk=','REFUQ'.'Q==','ey'.'I=','V'.'1dBTE'.'xfTE9'.'DSw'.'==',''.'c2'.'Vj'.'d'.'X'.'JpdHk=','U'.'0VDV'.'VJJ'.'V'.'FlfV1d'.'BTExfRVhDR'.'VBUSU9O',''.'R'.'k'.'FJ'.'T'.'F9D'.'SE'.'VDS0'.'lORw==','Q'.'2'.'FuIG5vdC'.'BleGV'.'jdXRlIH'.'d3'.'YWxsI'.'HJ1b'.'GVzO'.'iA=','IFRyY'.'WNlOiA=','UkVRVUVTVF9VUkk=','a2'.'V5cw'.'==','d'.'m'.'Fsd'.'WVz','U0VD'.'VV'.'JJV'.'FlfV1dBTE'.'x'.'fTU9ES'.'UZZ','Lg==','U0VDVVJ'.'JVFl'.'fV'.'1dBTEx'.'fVU5T'.'RVQ=','L'.'g==','U0VD'.'VVJJVFlfV1dBTEx'.'f'.'RVhJVA==','Lg==','Z2xv'.'YmFs',''.'a2V5'.'cw='.'=','d'.'mFsdWVz','Z2V0',''.'Z'.'2V0',''.'c'.'G'.'9zd'.'A'.'==','cG9z'.'dA'.'==','Y'.'29v'.'a2ll','Y29va2ll','c'.'mVxdWVzdA==','cm'.'VxdWVzd'.'A'.'='.'=','Z'.'2xvYm'.'Fs',''.'Z2xvYmFs','bWFpbl9zZWM=','V1dBTExfQUNU'.'V'.'U'.'F'.'MS'.'Vp'.'FX1'.'J'.'V'.'TE'.'VT','dg'.'==',''.'dmVy'.'c2lvbg==',''.'aQ==','a'.'XNJbnN0YWxsZW'.'Q=','dg==','aW5p','bW9kdWxlcw==','bGljZW5z'.'Z'.'Q'.'='.'=','cGh'.'w','d'.'g='.'=','ZXh0','c'.'2VjdXJpdHk=',''.'ZGI=',''.'dHl'.'wZ'.'Q==','ZGI=',''.'dm'.'V'.'yc2lv'.'bg==','ZGI=','dHlwZ'.'Q==','ZGI'.'=','dHlwZQ'.'==','dmVyc'.'2lvbg==','ZGI=','dm'.'V'.'yc2lvbg==','Z'.'W5'.'2aX'.'Jvbm1lbnQ=',''.'dm1f'.'dmVyc2lvbg==','d'.'m0'.'=','dg==','ZW5'.'2'.'aXJvbm'.'1lbnQ'.'=','dm'.'1fdmVyc2lvbg==',''.'c'.'29j'.'a2V0'.'VG'.'ltZW9'.'1dA==','c3RyZWFt'.'V'.'GltZW91'.'d'.'A==','KCc=','ZGF0YQ==','JywgJw==',''.'bW9kdW'.'xl','JywgJw'.'==','bW9k'.'d'.'WxlX3Zl'.'cnN'.'pb'.'24=','Jyk=','L'.'CA=',''.'U0VDVVJJ'.'VFlfV1dBT'.'ExfRVh'.'DR'.'VB'.'USU9'.'O','bWFpbg==','RkFJT'.'F9SRUZSR'.'VNI'.'S'.'U5'.'H','Q'.'2F'.'u'.'IG5vdCB'.'yZWZyZX'.'NoI'.'H'.'d3YW'.'x'.'sI'.'HJ1b'.'GV'.'z'.'OiA=','IFR'.'y'.'Y'.'W'.'NlO'.'i'.'A=',''.'Z'.'GF'.'0YQ==','eyI=','LS'.'0tL'.'S1CRUdJTiBQVUJM'.'SUM'.'gS0VZLS'.'0tLS0'.'=','Ck1J'.'S'.'U'.'J'.'J'.'ak'.'FO'.'QmdrcWh'.'r'.'aUc5dz'.'BC'.'QVFFRkFBT0NB'.'UThBTUlJQ'.'kNnS0NBU'.'UVBcThR'.'RTBIam1ISlV'.'TdFd'.'WNm4w'.'emEK'.'UlZvT'.'Hgw'.'Mkt6Ym'.'Z'.'yYlMv'.'U'.'DZzV2F4VHp3OFNlR1R'.'0YlRD'.'T'.'3J'.'w'.'SGk1UUY2T1J5alovWH'.'h'.'6L0tMVTFH'.'Ym9mOU'.'NaMwo0ejd'.'Ta3'.'FVdDY2a'.'WJYd'.'k9'.'G'.'Qng'.'0'.'ZncvQVB'.'QUkdEcX'.'R'.'t'.'M'.'G5EM2ZnR3'.'N1M1Jl'.'U'.'Gd3'.'Mj'.'lpOCt2bT'.'dtdEJ'.'LSlVZbD'.'R'.'yCl'.'ZwYjZzZl'.'pFVDl'.'LRWI2VDFIRFltRX'.'ZjMWhxL'.'2l'.'p'.'dXl4'.'THJa'.'W'.'m'.'k1UTZVZmY0VU'.'V2VE'.'krN'.'jhzc0ZSa1Erb3'.'dU'.'Un'.'kKZU9'.'J'.'T'.'WJGaE0vVV'.'Rt'.'ZlZZY'.'lRSRnky'.'b1VROFdNemE'.'ybk'.'o1U2'.'FoemkxVUtP'.'MWpBalhU'.'UF'.'Jy'.'emM3QWp1'.'N'.'jM5'.'ajFPMApwcHFm'.'bTV4Z1'.'dsRkFKa'.'0hRVGd'.'iZG'.'Q'.'1QV'.'dxRE'.'ZR'.'a3Q'.'5SEtrWStUbmZ'.'CT'.'EdWT'.'XZW'.'eVB3'.'VE'.'hOV1F'.'ZQXc0eHBnL3'.'dBClp3'.'S'.'URBUUF'.'CC'.'i0tLS0'.'tRU5EIFBVQ'.'kxJQyBL'.'RV'.'ktLS'.'0'.'t'.'LQ==');return base64_decode($_1877197783[$_445749331]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_1410653328= 'https://wwall.bitrix.info/rules.php'; protected $_1433091540= true; public function handle(){ try{  $_1084098947= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_1084098947)){ return;}  $_1640816842= Cache::createInstance(); $_109201294= false; if($_1640816842->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_1370799018= $_1640816842->getVars(); if($GLOBALS['____1606185122'][0]()- $_1370799018> round(0+20)){  $_1383878404= Application::getConnection(); $_129389013= RuleRecordTable::getTableName(); $_1383878404->truncateTable($_129389013); RuleRecordTable::cleanCache(); $_1640816842->clean(___1059425104(0), ___1059425104(1));}} elseif($_1640816842->startDataCache()){  $_1640816842->endDataCache($GLOBALS['____1606185122'][1]()); $_109201294= true;} foreach($_1084098947 as $_1513377393){ $_1564131055= new PublicKeyCipher; $_931191687= $_1564131055->decrypt($_1513377393[___1059425104(2)], static::__714296203()); if(!str_starts_with($_931191687, ___1059425104(3))){ continue;} $_1615846337= $GLOBALS['____1606185122'][2]($_931191687, true); if(!empty($_1615846337)){ $_930112818= Rule::make($_1615846337); $_1454086118= $this->handleRule($_930112818); $this->applyHandlingResults($_1454086118);}}  if($_109201294){ $_1640816842->clean(___1059425104(4), ___1059425104(5));}} catch(\Throwable $_294808535){ $this->logEvent( ___1059425104(6), ___1059425104(7), ___1059425104(8). $_294808535->getMessage(). ___1059425104(9). $_294808535->getTraceAsString());}}  public function handleRule(Rule $_930112818): array{ $_1454086118=[]; if($_930112818->matchPath($_SERVER[___1059425104(10)])){  $_176667638= $this->getContextElements($_930112818->getContext()); foreach($_176667638 as $_1941297745 => &$_1239423559){ $_1454086118= $GLOBALS['____1606185122'][3]($_1454086118, $this->recursiveContextKeyHandle($_1941297745, $_1239423559,[], $_930112818));}} return $_1454086118;}  public function applyHandlingResults(array $_1454086118){ $_176667638= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1454086118 as $_2028857923){ $_1239423559=& $_176667638[$_2028857923->getContextName()]; $_275672283= $_2028857923->getRuleResult(); $_930112818= $_2028857923->getRule(); if($_275672283 instanceof ModifyResult){ if($_930112818->getProcess() === ___1059425104(11)){  static::rewriteContextKey( $_2028857923->getContextName(), $_1239423559, $_2028857923->getContextKey(), $_275672283->getCleanValue());} elseif($_930112818->getProcess() === ___1059425104(12)){ static::rewriteContextValue( $_2028857923->getContextName(), $_1239423559, $_2028857923->getContextKey(), $_275672283->getCleanValue());} $this->logEvent( ___1059425104(13), $_2028857923->getContextName(), $GLOBALS['____1606185122'][4](___1059425104(14), $_2028857923->getContextKey()));} elseif($_275672283 instanceof CheckResult &&!$_275672283->isSuccess()){ if($_275672283->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_2028857923->getContextName(), $_1239423559, $_2028857923->getContextKey(),); $this->logEvent( ___1059425104(15), $_2028857923->getContextName(), $GLOBALS['____1606185122'][5](___1059425104(16), $_2028857923->getContextKey()));} elseif($_275672283->getAction() === RuleAction::EXIT){ $this->logEvent( ___1059425104(17), $_2028857923->getContextName(), $GLOBALS['____1606185122'][6](___1059425104(18), $_2028857923->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_1433091540= false;} protected function rewriteContextKey($_1941297745, &$_1239423559, $_1700904603, $_1848522467){ $_1001300894= $_1700904603;  $GLOBALS['____1606185122'][7]($_1001300894); $_1001300894[]= $_1848522467; if($_1941297745 === ___1059425104(19)){ $_1892945604= $GLOBALS['____1606185122'][8]($_1700904603); $GLOBALS['____1606185122'][9]($_1001300894); if(empty($_1700904603)){ $GLOBALS[$_1848522467]= $GLOBALS[$_1892945604]; unset($GLOBALS[$_1892945604]);} else{ $_1239423559=& $GLOBALS[$_1892945604]; $_1341159590= ArrayHelper::getByNestedKey($_1239423559, $_1700904603);  ArrayHelper::setByNestedKey($_1239423559, $_1001300894, $_1341159590);  ArrayHelper::unsetByNestedKey($_1239423559, $_1700904603);}} else{ $_1341159590= ArrayHelper::getByNestedKey($_1239423559, $_1700904603);  ArrayHelper::setByNestedKey($_1239423559, $_1001300894, $_1341159590);  ArrayHelper::unsetByNestedKey($_1239423559, $_1700904603);}} protected function rewriteContextValue($_1941297745, &$_1239423559, $_100945030, $_1341159590){ if($_1941297745 === 'global'){ $_1892945604= $GLOBALS['____1606185122'][10]($_100945030); if(empty($_100945030)){ $GLOBALS[$_1892945604]= $_1341159590;} else{ $_1239423559=& $GLOBALS[$_1892945604]; ArrayHelper::setByNestedKey($_1239423559, $_100945030, $_1341159590);}} else{  ArrayHelper::setByNestedKey($_1239423559, $_100945030, $_1341159590);}} protected function unsetContextValue($_1941297745, &$_1239423559, $_100945030){ if($_1941297745 === 'global'){ $_1892945604= $GLOBALS['____1606185122'][11]($_100945030); if(empty($_100945030)){ unset($GLOBALS[$_1892945604]);} else{ $_1239423559=& $GLOBALS[$_1892945604]; ArrayHelper::unsetByNestedKey($_1239423559, $_100945030);}} else{ ArrayHelper::unsetByNestedKey($_1239423559, $_100945030);}}  protected function recursiveContextKeyHandle(string $_1941297745, array &$_1239423559, array $_1013960846, Rule $_930112818): array{  $_1454086118=[]; foreach($_1239423559 as $_1933886958 => $_1341159590){ $_100945030= $GLOBALS['____1606185122'][12]($_1013960846,[$_1933886958]); if($_930112818->matchKey($_100945030)){  if($_930112818->getProcess() === ___1059425104(20)){ $_275672283= $_930112818->evaluate($_1933886958);} elseif($_930112818->getProcess() === ___1059425104(21)){ $_275672283= $_930112818->evaluateValue($_1341159590);}  if(!empty($_275672283) && $_275672283 instanceof RuleResult){ $_1454086118[]= new HandlingResult($_1941297745, $_100945030, $_275672283, $_930112818);}}  if($GLOBALS['____1606185122'][13]($_1341159590)){ $_1454086118= $GLOBALS['____1606185122'][14]($_1454086118, $this->recursiveContextKeyHandle( $_1941297745, $_1239423559[$_1933886958], $_100945030, $_930112818));}} return $_1454086118;} protected function getContextElements(array $_856596005){ $_729280723=[]; if($GLOBALS['____1606185122'][15](___1059425104(22), $_856596005, true)){ $_729280723[___1059425104(23)]= &$_GET;} if($GLOBALS['____1606185122'][16](___1059425104(24), $_856596005, true)){ $_729280723[___1059425104(25)]= &$_POST;} if($GLOBALS['____1606185122'][17](___1059425104(26), $_856596005, true)){ $_729280723[___1059425104(27)]= &$_COOKIE;} if($GLOBALS['____1606185122'][18](___1059425104(28), $_856596005, true)){ $_729280723[___1059425104(29)]= &$_REQUEST;} if($GLOBALS['____1606185122'][19](___1059425104(30), $_856596005, true)){ $_729280723[___1059425104(31)]= $GLOBALS;} return $_729280723;} public static function refreshRules(){ try{ $_824563204= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1606185122'][20]()- $_824563204)< static::CACHE_RULES_TTL){ return;} Option::set(___1059425104(32), ___1059425104(33), $GLOBALS['____1606185122'][21]()); $_1240619761= null;  $_57864513= $GLOBALS['____1606185122'][22](function($_385195417){ return[___1059425104(34) => $_385195417[___1059425104(35)], ___1059425104(36) => (int) $_385195417[___1059425104(37)]];}, ModuleManager::getModulesFromDisk());  $_828339128=[]; foreach($GLOBALS['____1606185122'][23]() as $_553563829){ $_1886865657= new ReflectionExtension($_553563829); $_828339128[$_553563829]=[ ___1059425104(38) => $_1886865657->getVersion(), ___1059425104(39) => $_1886865657->getINIEntries()];} $_117587107=[ ___1059425104(40) => $GLOBALS['____1606185122'][24]($_57864513), ___1059425104(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___1059425104(42) => $GLOBALS['____1606185122'][25]([ ___1059425104(43) => $GLOBALS['____1606185122'][26](), ___1059425104(44) => $_828339128])]; if(Loader::includeModule(___1059425104(45))){ $_437294918= CSecuritySystemInformation::getSystemInformation(); if(isset($_437294918[___1059425104(46)][___1059425104(47)]) && isset($_437294918[___1059425104(48)][___1059425104(49)])){ $_117587107[___1059425104(50)]=[ ___1059425104(51) => $_437294918[___1059425104(52)][___1059425104(53)], ___1059425104(54) => $_437294918[___1059425104(55)][___1059425104(56)]];} if(isset($_437294918[___1059425104(57)][___1059425104(58)])){ $_117587107[___1059425104(59)]=[___1059425104(60) => $_437294918[___1059425104(61)][___1059425104(62)]];}}  $_1763840583= new HttpClient([ ___1059425104(63) => round(0+5), ___1059425104(64) => round(0+1+1+1+1+1)]); $_1171251104= $_1763840583->post( static::$_1410653328, $_117587107); if($_1763840583->getStatus() == round(0+100+100) &&!empty($_1171251104)){ $_1240619761= Json::decode($_1171251104);}  if($_1240619761 !== null){ $_1383878404= Application::getConnection(); $_129389013= RuleRecordTable::getTableName(); if(!empty($_1240619761)){ foreach($_1240619761 as $_2046808625){ if(!static::checkRuleSign($_2046808625)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1606185122'][27]($_2046808625));}}}  $_1383878404->truncateTable($_129389013);  if(!empty($_1240619761)){ $_2066213179=[]; foreach($_1240619761 as $_2046808625){ $_2066213179[]= ___1059425104(65). $_1383878404->getSqlHelper()->forSql($_2046808625[___1059425104(66)]). ___1059425104(67). $_1383878404->getSqlHelper()->forSql($_2046808625[___1059425104(68)]). ___1059425104(69). $_1383878404->getSqlHelper()->forSql($_2046808625[___1059425104(70)]). ___1059425104(71);} $_1277740232= $GLOBALS['____1606185122'][28](___1059425104(72), $_2066213179);  $_1383878404->query("INSERT INTO {$_129389013} (DATA, MODULE, MODULE_VERSION) VALUES {$_1277740232}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_294808535){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___1059425104(73), ___1059425104(74), ___1059425104(75), ___1059425104(76). $_294808535->getMessage(). ___1059425104(77). $_294808535->getTraceAsString());}} protected static function checkRuleSign($_930112818){ $_1564131055= new PublicKeyCipher; $_1615846337= $_1564131055->decrypt($_930112818[___1059425104(78)], static::__714296203()); return str_starts_with($_1615846337, ___1059425104(79));} private static function __714296203(){ $_270487934= ''; $_270487934 .= ___1059425104(80); $_270487934 .= ___1059425104(81); return $_270487934;} protected function logEvent($_978937466, $_1264592617, $_1700875490){ if($this->_1433091540){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_978937466, 'main', $_1264592617, $_1700875490);}}}?>